---
applyTo: "**/*"
excludeAgent: copilot_code_review
---

# Package Development Workflow

## Purpose & Scope

Guidelines for developing, building, and maintaining this R package.

---

## Development Commands

### Daily Workflow

```r
# Load package for testing
devtools::load_all()

# Update documentation after roxygen changes
devtools::document()

# Run tests
devtools::test()

# Full package check
devtools::check()
```

### Before Committing

Always run these before committing:

```r
devtools::document()  # Regenerate man/ files
devtools::test()      # Ensure tests pass
devtools::check()     # Full R CMD check
```

---

## Adding a New Function

1. Create `R/{function_name}.R`
2. Add roxygen2 documentation
3. Run `devtools::document()`
4. Create `tests/testthat/test-{function_name}.R`
5. Run `devtools::test()`
6. Update README.Rmd if user-facing
7. **Update `_pkgdown.yml` reference index if function is exported**
8. Run `devtools::check()`

### Example New Function

```r
# R/new_function.R
#' @title New plotting utility
#'
#' @param p A ggplot object
#' @param option A configuration option
#'
#' @return Modified ggplot object
#' @export
#'
#' @examples
#' p <- ggplot2::ggplot(mtcars, ggplot2::aes(mpg, hp))
#' new_function(p, option = TRUE)
new_function <- function(p, option = FALSE) {
  # Implementation
  p
}
```

---

## Modifying Existing Functions

1. Update the function code
2. Update roxygen documentation if signature changes
3. Update or add tests
4. Run `devtools::test()`
5. Run `devtools::check()`
6. Update README.Rmd if behavior changed

---

## Documentation

### README

- Edit `README.Rmd`, not `README.md`
- Knit to regenerate: `rmarkdown::render("README.Rmd")`
- Images go in `man/figures/`

### Function Docs

- Generated by roxygen2 from `#'` comments
- Run `devtools::document()` after changes
- Never edit `man/*.Rd` files directly

### Vignettes

- Located in `vignettes/`
- Built during `R CMD check`
- Use `rmarkdown::html_vignette` output format

### pkgdown Reference Index

- **ALWAYS** update `_pkgdown.yml` when adding or removing exported functions
- Every exported function (`@export`) must be listed in the `reference:` section
- Group related functions under appropriate titles
- Run `pkgdown::build_site()` locally to verify the build succeeds

```yaml
# Example _pkgdown.yml reference section
reference:
- title: Section Title
  desc: Description of the section
  contents:
  - function_name
  - another_function
```

---

## Dependencies

### Adding New Dependency

1. Add to DESCRIPTION under `Imports:` or `Suggests:`
2. Add `@importFrom` in roxygen comments
3. Update `renv.lock`: `renv::snapshot()`

### Dependency Types

- **Imports**: Required packages
- **Suggests**: Optional (for tests, examples, vignettes)

---

## Environment Setup

### Local Development

```r
# Install dependencies from renv.lock
renv::restore()

# Add new dependency and update lock file
install.packages("newpkg")
renv::snapshot()
```

### GitHub Actions

- Uses `r-lib/actions/setup-r-dependencies@v2`
- System deps in `copilot-setup-steps.yml`

---

## CI/CD Workflows

| Workflow | Purpose |
|----------|---------|
| `R-CMD-check.yaml` | Full package check on multiple OS/R versions |
| `test-coverage.yaml` | Code coverage with codecov |
| `pkgdown.yaml` | Build and deploy documentation site |

---

## Troubleshooting

### Common Issues

**"Object not found" errors**

- Run `devtools::load_all()` to reload package
- Check function is exported with `@export`

**Documentation not updating**

- Run `devtools::document()`
- Check roxygen comments syntax

**Tests failing in CI but not locally**

- Check for platform-specific issues
- Ensure all test dependencies in Suggests

**Package check warnings**

- Run `devtools::check()` locally first
- Address NOTEs and WARNINGs before committing
